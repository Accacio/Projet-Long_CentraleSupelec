function y = MDI_kuka(q,dq, ddq, param, nom_param)

% Objectif: Calcul du modèle dinamique inverse du robot
% Entrées: 	q = vecteur des cinq positions angulaires
%			dq = vecteur des cinq vitesses angulaires
%			ddq = vecteur des cinq accélérations angulaires
%			param = strucures avec les paramètres physiques du robot (masse, gravité, inertie, coefficient de frottement)
% Sortie: 	y = le vecteur des couples dans chaque articulation

th2 = q(2);
th3 = q(3);
th4 = q(4);
th5 = q(5);

QP1 = dq(1);
QP2 = dq(2);
QP3 = dq(3);
QP4 = dq(4);
QP5 = dq(5);

QDP1 = ddq(1);
QDP2 = ddq(2);
QDP3 = ddq(3);
QDP4 = ddq(4);
QDP5 = ddq(5);

nb_param = length(nom_param);

for k = 1:nb_param
    variable = nom_param{k};
    valeur = param.(nom_param{k});
    eval([variable '= valeur;']);
    eval(['FX',num2str(k),'=0;']);
    eval(['FY',num2str(k),'=0;']);
    eval(['FZ',num2str(k),'=0;']);
    eval(['CX',num2str(k),'=0;']);
    eval(['CY',num2str(k),'=0;']);
    eval(['CZ',num2str(k),'=0;']);
end

C2 = cos(th2);
S2 = sin(th2);
C3 = cos(th3);
S3 = sin(th3);
C4 = cos(th4);
S4 = sin(th4);
C5 = cos(th5);
S5 = sin(th5);
DV61 = QP1^2;
W12 = QP1*S2;
W22 = C2*QP1;
WP12 = QDP1*S2 + QP2*W22;
WP22 = C2*QDP1 - QP2*W12;
DV22 = W12*W22;
DV32 = QP2*W12;
DV42 = W22^2;
DV52 = QP2*W22;
DV62 = QP2^2;
U112 = -DV42 - DV62;
U212 = DV22 + QDP2;
U312 = DV32 - WP22;
U322 = DV52 + WP12;
VSP12 = -DV61*d2;
VSP22 = QDP1*d2;
VP12 = C2*VSP12 - GZ*S2;
VP22 = -C2*GZ - S2*VSP12;
W13 = C3*W12 + S3*W22;
W23 = C3*W22 - S3*W12;
W33 = QP2 + QP3;
WP13 = C3*WP12 + QP3*W23 + S3*WP22;
WP23 = C3*WP22 - QP3*W13 - S3*WP12;
WP33 = QDP2 + QDP3;
DV13 = W13^2;
DV23 = W13*W23;
DV33 = W13*W33;
DV43 = W23^2;
DV53 = W23*W33;
DV63 = W33^2;
U113 = -DV43 - DV63;
U213 = DV23 + WP33;
U313 = DV33 - WP23;
U123 = DV23 - WP33;
U223 = -DV13 - DV63;
U323 = DV53 + WP13;
VSP13 = U112*d3 + VP12;
VSP23 = U212*d3 + VP22;
VSP33 = U312*d3 - VSP22;
VP13 = C3*VSP13 + S3*VSP23;
VP23 = C3*VSP23 - S3*VSP13;
W14 = C4*W13 + S4*W23;
W24 = C4*W23 - S4*W13;
W34 = QP4 + W33;
WP14 = C4*WP13 + QP4*W24 + S4*WP23;
WP24 = C4*WP23 - QP4*W14 - S4*WP13;
WP34 = QDP4 + WP33;
DV14 = W14^2;
DV24 = W14*W24;
DV34 = W14*W34;
DV44 = W24^2;
DV54 = W24*W34;
DV64 = W34^2;
U114 = -DV44 - DV64;
U214 = DV24 + WP34;
U314 = DV34 - WP24;
U124 = DV24 - WP34;
U224 = -DV14 - DV64;
U324 = DV54 + WP14;
VSP14 = U113*d4 + VP13;
VSP24 = U213*d4 + VP23;
VSP34 = U313*d4 + VSP33;
VP14 = C4*VSP14 + S4*VSP24;
VP24 = C4*VSP24 - S4*VSP14;
W15 = C5*W14 - S5*W34;
W25 = -C5*W34 - S5*W14;
W35 = QP5 + W24;
WP15 = C5*WP14 + QP5*W25 - S5*WP34;
WP25 = -C5*WP34 - QP5*W15 - S5*WP14;
WP35 = QDP5 + WP24;
DV15 = W15^2;
DV25 = W15*W25;
DV35 = W15*W35;
DV45 = W25^2;
DV55 = W25*W35;
DV65 = W35^2;
U115 = -DV45 - DV65;
U215 = DV25 + WP35;
U315 = DV35 - WP25;
U125 = DV25 - WP35;
U225 = -DV15 - DV65;
U325 = DV55 + WP15;
VP15 = C5*VP14 - S5*VSP34;
VP25 = -C5*VSP34 - S5*VP14;
No31 = QDP1*ZZR1;
F32 = MXR2*U312 + MY2*U322;
PSI12 = QP2*XZR2 + W12*XXR2 + W22*XY2;
PSI22 = QP2*YZ2 + W12*XY2;
PSI32 = QP2*ZZR2 + W12*XZR2 + W22*YZ2;
No12 = -PSI22*QP2 + PSI32*W22 + QDP2*XZR2 + WP12*XXR2 + WP22*XY2;
No22 = PSI12*QP2 - PSI32*W12 + QDP2*YZ2 + WP12*XY2;
No32 = -PSI12*W22 + PSI22*W12 + QDP2*ZZR2 + WP12*XZR2 + WP22*YZ2;
F13 = MXR3*U113 + MY3*U123;
F23 = MXR3*U213 + MY3*U223;
F33 = MXR3*U313 + MY3*U323;
PSI13 = W13*XXR3 + W23*XY3 + W33*XZR3;
PSI23 = W13*XY3 + W33*YZ3;
PSI33 = W13*XZR3 + W23*YZ3 + W33*ZZR3;
No13 = -PSI23*W33 + PSI33*W23 + WP13*XXR3 + WP23*XY3 + WP33*XZR3;
No23 = PSI13*W33 - PSI33*W13 + WP13*XY3 + WP33*YZ3;
No33 = -PSI13*W23 + PSI23*W13 + WP13*XZR3 + WP23*YZ3 + WP33*ZZR3;
F14 = MX4*U114 + MYR4*U124;
F24 = MX4*U214 + MYR4*U224;
F34 = MX4*U314 + MYR4*U324;
PSI14 = W14*XXR4 + W24*XY4 + W34*XZ4;
PSI24 = W14*XY4 + W34*YZ4;
PSI34 = W14*XZ4 + W24*YZ4 + W34*ZZR4;
No14 = -PSI24*W34 + PSI34*W24 + WP14*XXR4 + WP24*XY4 + WP34*XZ4;
No24 = PSI14*W34 - PSI34*W14 + WP14*XY4 + WP34*YZ4;
No34 = -PSI14*W24 + PSI24*W14 + WP14*XZ4 + WP24*YZ4 + WP34*ZZR4;
F15 = MX5*U115 + MY5*U125;
F25 = MX5*U215 + MY5*U225;
F35 = MX5*U315 + MY5*U325;
PSI15 = W15*XXR5 + W25*XY5 + W35*XZ5;
PSI25 = W15*XY5 + W35*YZ5;
PSI35 = W15*XZ5 + W25*YZ5 + W35*ZZ5;
No15 = -PSI25*W35 + PSI35*W25 + WP15*XXR5 + WP25*XY5 + WP35*XZ5;
No25 = PSI15*W35 - PSI35*W15 + WP15*XY5 + WP35*YZ5;
No35 = -PSI15*W25 + PSI25*W15 + WP15*XZ5 + WP25*YZ5 + WP35*ZZ5;
E15 = F15 + FX5;
E25 = F25 + FY5;
E35 = F35 + FZ5;
N15 = CX5 + MY5*VP24 + No15;
N25 = CY5 - MX5*VP24 + No25;
N35 = CZ5 + MX5*VP25 - MY5*VP15 + No35;
FDI15 = C5*E15 - E25*S5;
FDI35 = -C5*E25 - E15*S5;
E14 = F14 + FDI15;
E24 = E35 + F24;
E34 = F34 + FDI35;
N14 = C5*N15 + MYR4*VSP34 - N25*S5 + No14;
N24 = -MX4*VSP34 + N35 + No24;
N34 = -C5*N25 + MX4*VP24 - MYR4*VP14 - N15*S5 + No34;
FDI14 = C4*E14 - E24*S4;
FDI24 = C4*E24 + E14*S4;
E13 = F13 + FDI14;
E23 = F23 + FDI24;
E33 = E34 + F33;
N13 = C4*N14 + MY3*VSP33 - N24*S4 + No13;
N23 = C4*N24 - E34*d4 - MXR3*VSP33 + N14*S4 + No23;
N33 = FDI24*d4 + MXR3*VP23 - MY3*VP13 + N34 + No33;
FDI23 = C3*E23 + E13*S3;
E32 = E33 + F32;
N12 = C3*N13 - MY2*VSP22 - N23*S3 + No12;
N22 = C3*N23 - E33*d3 + MXR2*VSP22 + N13*S3 + No22;
N32 = FDI23*d3 + MXR2*VP22 - MY2*VP12 + N33 + No32;
N31 = C2*N22 - E32*d2 + N12*S2 + No31;
GAM1 = FS1*sign(QP1) + FV1*QP1 + N31;
GAM2 = FS2*sign(QP2) + FV2*QP2 + N32;
GAM3 = FS3*sign(QP3) + FV3*QP3 + IA3*QDP3 + N33;
GAM4 = FS4*sign(QP4) + FV4*QP4 + IA4*QDP4 + N34;
GAM5 = FS5*sign(QP5) + FV5*QP5 + IA5*QDP5 + N35;

y = [GAM1 GAM2 GAM3 GAM4 GAM5].';